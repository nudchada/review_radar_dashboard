<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin Datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        /* Base Settings */
        html, body { 
            background-color: #f0f2f5; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏≤‡∏ü‡πâ‡∏≤‡∏à‡∏≤‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥‡∏Ç‡∏∂‡πâ‡∏ô */
            font-family: 'Sarabun', sans-serif; 
            height: 100%; 
            overflow: hidden; 
            color: #2c3e50;
        }

        .dashboard-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }

        .header-section {
            flex-shrink: 0; 
        }

        .content-area {
            flex-grow: 1;
            min-height: 0; 
            margin-top: 15px;
            overflow: hidden;
        }

        /* Filter Section */
        .filter-section { 
            background-color: #ffffff; 
            border-radius: 16px; 
            padding: 12px; 
            margin-bottom: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: center; 
        }

        .card-sentiment { 
            border: none; 
            border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            background: white;
        }
        
        .chart-container-pie {
            position: relative;
            height: 220px; 
            width: 100%;
        }
        .chart-container-bar {
            position: relative;
            height: 140px; 
            width: 100%;
        }

        .col-scrollable {
            height: 100%;
            overflow-y: auto; 
            padding-right: 5px; 
        }
        
        .col-scrollable::-webkit-scrollbar { width: 6px; }
        .col-scrollable::-webkit-scrollbar-track { background: transparent; }
        .col-scrollable::-webkit-scrollbar-thumb { background: #b0bec5; border-radius: 10px; }

        /* ‡∏õ‡∏∏‡πà‡∏° Toggle Custom (Updated Colors) */
        .platform-btn-group .btn {
            border-radius: 50px;
            margin-right: 8px;
            padding: 6px 18px;
            font-weight: 500;
            font-size: 0.9rem;
            border: 1px solid #cfd8dc;
            color: #546e7a;
            background-color: white;
            transition: all 0.2s;
        }
        .platform-btn-group .btn:hover {
            background-color: #eceff1;
            color: #37474f;
        }
        .platform-btn-group .btn.active {
            background-color: #42a5f5; /* ‡∏ü‡πâ‡∏≤‡∏™‡∏î‡πÉ‡∏™‡∏Ç‡∏∂‡πâ‡∏ô */
            color: white;
            border-color: #42a5f5;
            box-shadow: 0 2px 6px rgba(66, 165, 245, 0.3);
        }
        
        .badge-count {
            background-color: rgba(0,0,0,0.1);
            color: inherit;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75em;
            margin-left: 6px;
        }
        .btn.active .badge-count {
            background-color: rgba(255,255,255,0.25);
            color: white;
        }

        #loadingOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        @media (max-width: 992px) {
            html, body { height: auto; overflow: auto; }
            .dashboard-container { height: auto; display: block; }
            .content-area { height: auto; }
            .col-scrollable { height: auto; overflow: visible; }
            .chart-container-pie { height: 280px; }
        }

        /* --- Vivid Pastel Table Styles --- */
        .table-custom { font-size: 0.9rem; }
        .table-custom thead th {
            background-color: #f1f8e9; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            color: #33691e;
            font-weight: 600;
            border-bottom: 2px solid #dcedc8;
            border-right: 1px solid #dcedc8; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            padding-top: 12px;
            padding-bottom: 12px;
        }
        .table-custom tbody td {
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
            padding: 10px 8px;
        }
        /* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ */
        .table-custom thead th:last-child,
        .table-custom tbody td:last-child {
            border-right: none;
        }

        .comment-row:hover { background-color: #fffde7; } /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏à‡∏≤‡∏á‡πÜ ‡∏ï‡∏≠‡∏ô Hover */

        /* Badges ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (Vibrant Pastel) */
        .badge-pastel {
            font-size: 0.8em;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
        .badge-pos { background-color: #a5d6a7; color: #1b5e20; border: 1px solid #81c784; } 
        /* ‡πÅ‡∏î‡∏á: ‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
        .badge-neg { background-color: #ef9a9a; color: #b71c1c; border: 1px solid #e57373; } 
        /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: ‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
        .badge-neu { background-color: #ffe082; color: #f57f17; border: 1px solid #ffd54f; } 
        
        .badge-empty { color: #e0e0e0; font-size: 1.2em; font-weight: 300; } 

        .text-review {
            color: #424242;
            line-height: 1.5;
        }

        /* Logo Area */
        .logo-container {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 6px 18px;
            border-radius: 50px;
            border: 1px solid #eaeaea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

    </style>
</head>
<body>

<div class="container-fluid dashboard-container position-relative">
    
    <div id="loadingOverlay">
        <div class="spinner-border text-secondary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <!-- Header Section -->
    <div class="header-section">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            
            <!-- Left: Logo + Title -->
            <div class="d-flex align-items-center gap-3">
                <div class="logo-container me-1">
                    <img src="logo.jpg" alt="reviewradar_logo" style="height: 40px; width: auto;">
                </div>
                <div class="border-start h-100 mx-1" style="height: 25px; border-color: #ddd;"></div>
                <div>
                    <h5 class="fw-bold text-dark mb-0">Dashboard</h5>
                    <div class="text-muted small">Brand: <span class="fw-bold text-danger">Suki 42</span></div>
                </div>
            </div>

            <!-- Right: Navigation -->
            <div class="d-flex bg-white p-1 rounded-pill border shadow-sm">
                <button class="btn btn-primary btn-sm rounded-pill px-3 text-decoration-none" onclick="switchView('dashboard')" id="btn-view-dashboard">
                    <i class="fas fa-chart-pie me-1"></i> ‡∏Å‡∏£‡∏≤‡∏ü
                </button>
                <button class="btn btn-link text-decoration-none text-secondary btn-sm rounded-pill px-3" onclick="switchView('comments')" id="btn-view-comments">
                    <i class="fas fa-table me-1"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-section">
            <div class="platform-btn-group d-flex flex-wrap justify-content-center" id="platformGroup">
                <button type="button" class="btn active" onclick="selectPlatform('all', this)">
                    All Platforms <span id="count-all" class="badge-count">...</span>
                </button>
                <button type="button" class="btn" onclick="selectPlatform('youtube', this)">
                    <i class="fab fa-youtube text-danger opacity-75"></i> YouTube <span id="count-youtube" class="badge-count">...</span>
                </button>
                <button type="button" class="btn" onclick="selectPlatform('tiktok', this)">
                    <i class="fab fa-tiktok text-dark opacity-75"></i> TikTok <span id="count-tiktok" class="badge-count">...</span>
                </button>
                <button type="button" class="btn" onclick="selectPlatform('google', this)">
                    <i class="fab fa-google text-primary opacity-75"></i> Maps <span id="count-google" class="badge-count">...</span>
                </button>
            </div>

            <div class="d-none d-md-block border-start mx-3" style="height: 25px;"></div>

            <div class="d-flex gap-2 align-items-center bg-light px-3 py-1 rounded-pill border">
                <i class="far fa-calendar-alt text-secondary"></i>
                <input type="date" id="startDate" class="form-control form-control-sm border-0 bg-transparent" style="width: 135px; font-size: 0.9rem;" onchange="renderCurrentView()">
                <span class="align-self-center text-muted" style="font-size: 0.8rem;">to</span>
                <input type="date" id="endDate" class="form-control form-control-sm border-0 bg-transparent" style="width: 135px; font-size: 0.9rem;" onchange="renderCurrentView()">
            </div>
        </div>
    </div>

    <!-- VIEW 1: DASHBOARD -->
    <div id="view-dashboard" class="row content-area g-3">
        <!-- Left: Overall Pie -->
        <div class="col-lg-4 h-100">
            <div class="card card-sentiment h-100">
                <div class="card-body d-flex flex-column justify-content-center col-scrollable">
                    <h5 class="fw-bold text-center mb-3 text-dark">Overall Sentiment</h5>
                    <div class="chart-container-pie mb-3 d-flex justify-content-center">
                        <canvas id="overallChart"></canvas>
                    </div>
                    <div class="mt-2 p-3 rounded-3" style="background-color: #f1f8e9;"> <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏á‡πÜ -->
                        <div class="d-flex flex-column gap-2" id="overallStats"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Aspects Bar -->
        <div class="col-lg-8 h-100">
            <div class="col-scrollable">
                <div class="d-flex align-items-center mb-3">
                    <h6 class="fw-bold text-secondary mb-0 ps-2" style="border-left: 4px solid #66bb6a;">Aspect Breakdown</h6>
                </div>
                <div id="aspectGrid" class="row g-3 pb-4"></div>
            </div>
        </div>
    </div>

    <!-- VIEW 2: COMMENTS LIST (Matrix with Filters) -->
    <div id="view-comments" class="content-area d-none">
        <div class="card card-sentiment h-100 border-0">
            <div class="card-header bg-white py-3 border-bottom-0">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-list-alt me-2 text-primary"></i>Review Matrix</h5>
                    
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <!-- Aspect Filter (Brought Back) -->
                        <div class="d-flex align-items-center bg-light px-3 py-1 rounded-pill border">
                            <span class="small text-secondary fw-bold me-2">Aspect:</span>
                            <select id="aspectFilter" class="form-select form-select-sm border-0 bg-transparent p-0" style="width: auto; box-shadow: none; cursor: pointer; color: #1976d2; font-weight: 500;" onchange="renderCommentsList()">
                                <option value="all">All Aspects</option>
                                <option value="Taste">Taste (‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥)</option>
                                <option value="Price">Price (‡∏£‡∏≤‡∏Ñ‡∏≤)</option>
                                <option value="Service">Service (‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)</option>
                                <option value="Atmosphere">Atmosphere (‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®)</option>
                                <option value="Accessibility">Accessibility (‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á)</option>
                            </select>
                        </div>

                        <!-- Sentiment Filter -->
                        <div class="d-flex align-items-center bg-light px-4 py-1 rounded-pill border">
                            <span class="small text-secondary fw-bold me-2">Sentiment:</span>
                            <select id="sentimentFilter" class="form-select form-select-sm border-0 bg-transparent ps-0 pe-5" style="width: auto; box-shadow: none; cursor: pointer; color: #1976d2; font-weight: 500;" onchange="renderCommentsList()">
                                <option value="all">All Sentiments</option>
                                <option value="pos">Positive</option>
                                <option value="neg">Negative</option>
                                <option value="neu">Neutral</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-body col-scrollable p-0">
                <table class="table table-custom table-hover align-middle mb-0 w-100">
                    <thead class="sticky-top shadow-sm">
                        <tr>
                            <th scope="col" style="width: 10%" class="ps-4">Date</th>
                            <th scope="col" style="width: 8%">Source</th>
                            <th scope="col" style="width: 37%">Review</th>
                            <!-- Aspect Columns -->
                            <th scope="col" style="width: 9%" class="text-center">Taste</th>
                            <th scope="col" style="width: 9%" class="text-center">Price</th>
                            <th scope="col" style="width: 9%" class="text-center">Service</th>
                            <th scope="col" style="width: 9%" class="text-center">Atmos</th>
                            <th scope="col" style="width: 9%" class="text-center">Access</th>
                        </tr>
                    </thead>
                    <tbody id="commentsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    Chart.register(ChartDataLabels);

    document.getElementById('startDate').valueAsDate = new Date();
    document.getElementById('endDate').valueAsDate = new Date();

    let currentPlatform = 'all';
    let currentView = 'dashboard';
    let activeCharts = []; 
    let overallChartInstance = null;

    // Vibrant Pastel Colors Configuration (Adjusted)
    const COLORS = {
        pos: { bg: '#66bb6a', border: '#4caf50', hover: '#43a047' }, // Green 400 - ‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        neg: { bg: '#ef5350', border: '#e53935', hover: '#e53935' }, // Red 400 - ‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        neu: { bg: '#ffa726', border: '#fb8c00', hover: '#fb8c00' }, // Orange 400 - ‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        nm:  { bg: '#bdbdbd', border: '#9e9e9e', hover: '#757575' }  // Grey
    };

    // --- SERVICE LAYER ---
    const SentimentService = {
        _db: {
            "youtube": {
                name: "YouTube",
                aspects: {
                    "Taste": { pos: 800, neg: 50, neu: 150, nm: 0 }, 
                    "Price": { pos: 200, neg: 100, neu: 50, nm: 0 },
                    "Service": { pos: 300, neg: 80, neu: 100, nm: 0 },
                    "Atmosphere": { pos: 250, neg: 20, neu: 80, nm: 0 },
                    "Accessibility": { pos: 50, neg: 10, neu: 20, nm: 0 } 
                }
            },
            "tiktok": {
                name: "TikTok",
                aspects: {
                    "Taste": { pos: 1200, neg: 100, neu: 200, nm: 0 },
                    "Price": { pos: 400, neg: 300, neu: 100, nm: 0 },
                    "Service": { pos: 200, neg: 50, neu: 100, nm: 0 },
                    "Atmosphere": { pos: 500, neg: 50, neu: 100, nm: 0 },
                    "Accessibility": { pos: 80, neg: 20, neu: 30, nm: 0 }
                }
            },
            "google": {
                name: "Google Maps",
                aspects: {
                    "Taste": { pos: 300, neg: 30, neu: 50, nm: 0 },
                    "Price": { pos: 150, neg: 20, neu: 60, nm: 0 },
                    "Service": { pos: 100, neg: 100, neu: 40, nm: 0 },
                    "Atmosphere": { pos: 100, neg: 10, neu: 30, nm: 0 },
                    "Accessibility": { pos: 150, neg: 50, neu: 40, nm: 0 }
                }
            }
        },

        // Mock Comments
        _mockComments: [
            { id: 1, platform: 'youtube', date: '25 Oct 23', text: '‡∏ô‡πâ‡∏≥‡∏ã‡∏∏‡∏õ‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡∏Å‡∏Å‡∏Å ‡∏ä‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡πÜ üòã', sentiment: 'pos', aspect: 'Taste' },
            { id: 2, platform: 'tiktok', date: '25 Oct 23', text: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏ó‡∏±‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡∏¢‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏±‡∏î', sentiment: 'neg', aspect: 'Service' },
            { id: 3, platform: 'google', date: '24 Oct 23', text: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û', sentiment: 'pos', aspect: 'Price' },
            { id: 4, platform: 'tiktok', date: '24 Oct 23', text: '‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏â‡∏¢‡πÜ ‡∏ô‡∏∞ ‡∏ô‡πâ‡∏≥‡∏à‡∏¥‡πâ‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô', sentiment: 'neu', aspect: 'Taste' },
            { id: 5, platform: 'youtube', date: '23 Oct 23', text: '‡πÅ‡∏Ñ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ß‡∏∞‡∏Å‡∏¥‡∏ô', sentiment: 'nm', aspect: 'Atmosphere' }, 
            { id: 6, platform: 'google', date: '23 Oct 23', text: '‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≤‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏™‡∏∞‡∏≠‡πâ‡∏≤‡∏ô', sentiment: 'pos', aspect: 'Atmosphere' },
            { id: 7, platform: 'tiktok', date: '22 Oct 23', text: '‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏î‡∏µ‡∏¢‡πå ‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡∏ß‡∏ß', sentiment: 'pos', aspect: 'Taste' },
            { id: 8, platform: 'youtube', date: '22 Oct 23', text: '‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏ó‡πâ‡∏≠‡πÄ‡∏•‡∏¢‡∏¢‡∏¢ üò≠', sentiment: 'neg', aspect: 'Service' },
            { id: 9, platform: 'google', date: '21 Oct 23', text: '‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö', sentiment: 'nm', aspect: 'Service' }, 
            { id: 10, platform: 'tiktok', date: '21 Oct 23', text: '‡πÅ‡∏û‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì', sentiment: 'neg', aspect: 'Price' },
            { id: 11, platform: 'google', date: '20 Oct 23', text: '‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏´‡∏≤‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö', sentiment: 'neg', aspect: 'Accessibility' },
        ],

        _delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); },

        async getData(platform, startDate, endDate) {
            await this._delay(300);
            if (platform === 'all') {
                let aggregated = {};
                const firstKey = Object.keys(this._db)[0];
                const aspectKeys = Object.keys(this._db[firstKey].aspects);
                aspectKeys.forEach(k => aggregated[k] = { pos: 0, neg: 0, neu: 0, nm: 0 });
                Object.values(this._db).forEach(p => {
                    aspectKeys.forEach(k => {
                        const s = p.aspects[k];
                        aggregated[k].pos += s.pos; aggregated[k].neg += s.neg;
                        aggregated[k].neu += s.neu; aggregated[k].nm += s.nm;
                    });
                });
                return aggregated;
            } else {
                return this._db[platform].aspects;
            }
        },

        async getCommentsList(platform, startDate, endDate, sentiment = 'all', aspect = 'all') {
            await this._delay(300);
            let filtered = this._mockComments;
            if (platform !== 'all') filtered = filtered.filter(c => c.platform === platform);
            if (sentiment !== 'all') filtered = filtered.filter(c => c.sentiment === sentiment);
            if (aspect !== 'all') filtered = filtered.filter(c => c.aspect === aspect); // Filter by Aspect
            return filtered;
        },
        
        getCounts() {
            let counts = { all: 0 };
            for (const [key, data] of Object.entries(this._db)) {
                let platformTotal = 0;
                Object.values(data.aspects).forEach(s => {
                    platformTotal += (s.pos + s.neg + s.neu);
                });
                counts[key] = platformTotal;
                counts.all += platformTotal;
            }
            return counts;
        }
    };

    // --- CONTROLLER ---
    const counts = SentimentService.getCounts();
    document.getElementById('count-all').innerText = counts.all.toLocaleString();
    document.getElementById('count-youtube').innerText = counts.youtube.toLocaleString();
    document.getElementById('count-tiktok').innerText = counts.tiktok.toLocaleString();
    document.getElementById('count-google').innerText = counts.google.toLocaleString();

    function selectPlatform(platform, btnElement) {
        currentPlatform = platform;
        document.querySelectorAll('.platform-btn-group .btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        renderCurrentView(); 
    }

    function switchView(viewName) {
        currentView = viewName;
        const btnDash = document.getElementById('btn-view-dashboard');
        const btnComm = document.getElementById('btn-view-comments');
        
        if (viewName === 'dashboard') {
            document.getElementById('view-dashboard').classList.remove('d-none');
            document.getElementById('view-comments').classList.add('d-none');
            // Reset Button Style
            btnDash.classList.remove('btn-link', 'text-secondary'); 
            btnDash.classList.add('btn-primary');
            btnComm.classList.remove('btn-primary'); 
            btnComm.classList.add('btn-link', 'text-secondary');
        } else {
            document.getElementById('view-dashboard').classList.add('d-none');
            document.getElementById('view-comments').classList.remove('d-none');
            // Swap Button Style
            btnDash.classList.remove('btn-primary'); 
            btnDash.classList.add('btn-link', 'text-secondary');
            btnComm.classList.remove('btn-link', 'text-secondary'); 
            btnComm.classList.add('btn-primary');
        }
        renderCurrentView();
    }

    function renderCurrentView() {
        if (currentView === 'dashboard') renderDashboard();
        else renderCommentsList();
    }

    async function renderDashboard() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';

        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const data = await SentimentService.getData(currentPlatform, startDate, endDate);

            let overallScores = { pos: 0, neg: 0, neu: 0 };
            Object.values(data).forEach(s => {
                overallScores.pos += s.pos; overallScores.neg += s.neg; overallScores.neu += s.neu;
            });

            renderOverallChart(overallScores);
            updateOverallStats(overallScores);
            renderAspectGrid(data);

        } catch (error) {
            console.error(error);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    function renderOverallChart(scores) {
        if (overallChartInstance) overallChartInstance.destroy();
        const ctx = document.getElementById('overallChart').getContext('2d');
        const total = scores.pos + scores.neg + scores.neu;

        overallChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Positive', 'Negative', 'Neutral'],
                datasets: [{
                    data: [scores.pos, scores.neg, scores.neu],
                    backgroundColor: [COLORS.pos.bg, COLORS.neg.bg, COLORS.neu.bg],
                    borderWidth: 2,
                    borderColor: '#ffffff',
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                    tooltip: { enabled: true },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => {
                            if (total === 0) return '';
                            let pct = (value * 100 / total).toFixed(0);
                            return pct > 5 ? pct + '%' : '';
                        }
                    }
                }
            }
        });
    }

    function updateOverallStats(scores) {
        const total = scores.pos + scores.neg + scores.neu;
        const statsHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted"><span style="color:${COLORS.pos.bg}">‚óè</span> Positive</span> 
                <span class="fw-bold text-dark">${scores.pos.toLocaleString()}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small text-muted"><span style="color:${COLORS.neg.bg}">‚óè</span> Negative</span> 
                <span class="fw-bold text-dark">${scores.neg.toLocaleString()}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span class="small text-muted"><span style="color:${COLORS.neu.bg}">‚óè</span> Neutral</span> 
                <span class="fw-bold text-dark">${scores.neu.toLocaleString()}</span>
            </div>
        `;
        document.getElementById('overallStats').innerHTML = statsHTML;
    }

    function renderAspectGrid(aspectsData) {
        const container = document.getElementById('aspectGrid');
        activeCharts.forEach(c => c.destroy());
        activeCharts = [];
        container.innerHTML = '';

        let globalMax = 0;
        Object.values(aspectsData).forEach(scores => {
            const maxInAspect = Math.max(scores.pos, scores.neg, scores.neu);
            if (maxInAspect > globalMax) globalMax = maxInAspect;
        });
        globalMax = Math.ceil(globalMax * 1.1);

        Object.entries(aspectsData).forEach(([aspectName, scores], index) => {
            const mentionsCount = scores.pos + scores.neg + scores.neu;

            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = `
                <div class="card card-sentiment h-100 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="fw-bold mb-0 text-dark small">${aspectName}</h6>
                        <small class="text-muted" style="font-size: 0.75rem;">${mentionsCount.toLocaleString()} mentions</small>
                    </div>
                    <div class="chart-container-bar">
                        <canvas id="aspectChart-${index}"></canvas>
                    </div>
                </div>
            `;
            container.appendChild(col);

            const ctx = document.getElementById(`aspectChart-${index}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pos', 'Neg', 'Neu'],
                    datasets: [{
                        data: [scores.pos, scores.neg, scores.neu],
                        backgroundColor: [COLORS.pos.bg, COLORS.neg.bg, COLORS.neu.bg],
                        borderRadius: 4,
                        barPercentage: 0.5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, datalabels: { display: false } },
                    scales: {
                        x: { 
                            grid: { display: true, color: '#f0f0f0', drawBorder: false },
                            ticks: { font: { size: 10 }, color: '#999' },
                            max: globalMax 
                        },
                        y: { 
                            grid: { display: false },
                            ticks: { font: { size: 11, weight: '500' }, color: '#555' }
                        }
                    }
                }
            });
            activeCharts.push(chart);
        });
    }

    async function renderCommentsList() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';
        const tbody = document.getElementById('commentsTableBody');
        tbody.innerHTML = ''; 

        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const sentimentFilter = document.getElementById('sentimentFilter').value;
            const aspectFilter = document.getElementById('aspectFilter').value; // Get Aspect
            
            const comments = await SentimentService.getCommentsList(currentPlatform, startDate, endDate, sentimentFilter, aspectFilter);

            if (comments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
            } else {
                comments.forEach(c => {
                    let icon = '';
                    if(c.platform === 'youtube') icon = '<i class="fab fa-youtube text-danger opacity-75"></i>';
                    else if(c.platform === 'tiktok') icon = '<i class="fab fa-tiktok text-dark opacity-75"></i>';
                    else if(c.platform === 'google') icon = '<i class="fab fa-google text-primary opacity-75"></i>';

                    // Function to check aspect and return badge
                    const getBadge = (targetAspect) => {
                        if (c.aspect === targetAspect && c.sentiment !== 'nm') {
                            if (c.sentiment === 'pos') return '<span class="badge-pastel badge-pos">Pos</span>';
                            if (c.sentiment === 'neg') return '<span class="badge-pastel badge-neg">Neg</span>';
                            if (c.sentiment === 'neu') return '<span class="badge-pastel badge-neu">Neu</span>';
                        }
                        return '<span class="badge-empty">-</span>';
                    };

                    const tr = document.createElement('tr');
                    tr.className = 'comment-row';
                    tr.innerHTML = `
                        <td class="ps-4 text-muted small">${c.date}</td>
                        <td>${icon}</td>
                        <td><div class="text-review text-truncate" style="max-width: 350px;" title="${c.text}">${c.text}</div></td>
                        <td class="text-center">${getBadge('Taste')}</td>
                        <td class="text-center">${getBadge('Price')}</td>
                        <td class="text-center">${getBadge('Service')}</td>
                        <td class="text-center">${getBadge('Atmosphere')}</td>
                        <td class="text-center">${getBadge('Accessibility')}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (error) { console.error(error); } finally { loadingOverlay.style.display = 'none'; }
    }

    renderDashboard();

</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</body>
</html>